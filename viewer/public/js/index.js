class ${cache=new Map;async fetchJSON(w,O=!0){if(O&&this.cache.has(w))return this.cache.get(w);let P=await fetch(w);if(!P.ok)throw Error(`HTTP ${P.status}: ${P.statusText}`);let j=await P.json();if(O)this.cache.set(w,j);return j}async getExperiments(){return this.fetchJSON("/api/experiments")}async getExperiment(w){return this.fetchJSON(`/api/experiment/${w}`)}async getGenerationTrials(w,O){return this.fetchJSON(`/api/experiment/${w}/gen/${O}`)}async getTrial(w,O){return this.fetchJSON(`/api/experiment/${w}/trial/${O}`)}async getTrialCircles(w,O){return this.fetchJSON(`/api/experiment/${w}/trial/${O}/circles`,!1)}async getAllCircles(w){return this.fetchJSON(`/api/experiment/${w}/all-circles`,!1)}async getRootLog(w){return this.fetchJSON(`/api/experiment/${w}/root-log`)}formatDate(w){if(!w)return"Unknown";try{return new Date(w).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return w}}formatScore(w){if(w===null||w===void 0)return"-";return w.toFixed(4)}parseTrialId(w){let O=w.split("_");if(O.length>=3)return{generation:parseInt(O[1]),index:parseInt(O[2])};return null}buildLineageTree(w){let O=new Map,P=[];for(let q of w)O.set(q.trial_id,{...q,children:[]});for(let q of w){let z=O.get(q.trial_id),K=q.parent_id;if(!K||K==="root"||K==="null"||!O.has(K))P.push(z);else{let Q=O.get(K);if(Q)Q.children.push(z)}}let j=(q)=>{q.children.sort((z,K)=>{let Q=z.metrics?.sum_radii??z.metrics?.score??0;return(K.metrics?.sum_radii??K.metrics?.score??0)-Q});for(let z of q.children)j(z)};for(let q of P)j(q);return P.sort((q,z)=>{let K=q.metrics?.sum_radii??q.metrics?.score??0;return(z.metrics?.sum_radii??z.metrics?.score??0)-K}),P}}var J=new $;function E(w,O){let P=w/O;if(P<0.5){let j=P*2;return`hsl(${220-j*80}, 70%, ${50+j*10}%)`}else{let j=(P-0.5)*2;return`hsl(${140-j*100}, ${70+j*20}%, ${60+j*15}%)`}}function A(){let w=document.createElementNS("http://www.w3.org/2000/svg","svg");w.setAttribute("viewBox","0 0 1 1"),w.setAttribute("preserveAspectRatio","xMidYMid meet"),w.style.width="100%",w.style.height="100%";let O=document.createElementNS("http://www.w3.org/2000/svg","rect");O.setAttribute("x","0"),O.setAttribute("y","0"),O.setAttribute("width","1"),O.setAttribute("height","1"),O.setAttribute("fill","#1a1a2e"),w.appendChild(O);let P=document.createElementNS("http://www.w3.org/2000/svg","rect");return P.setAttribute("x","0"),P.setAttribute("y","0"),P.setAttribute("width","1"),P.setAttribute("height","1"),P.setAttribute("fill","none"),P.setAttribute("stroke","#3a3a5a"),P.setAttribute("stroke-width","0.002"),w.appendChild(P),w}function M(w,O,P=null){if(w.innerHTML="",!O||!O.valid||!O.centers||!O.radii){w.innerHTML='<div class="placeholder-small">No valid packing data</div>';return}let j=A(),q=O.centers,z=O.radii,K=Math.max(...z),Q=document.createElementNS("http://www.w3.org/2000/svg","g");for(let U=0;U<q.length;U++){let[Y,_]=q[U],Z=z[U],W=document.createElementNS("http://www.w3.org/2000/svg","circle");W.setAttribute("cx",String(Y)),W.setAttribute("cy",String(1-_)),W.setAttribute("r",String(Z)),W.setAttribute("fill",E(Z,K)),W.setAttribute("fill-opacity","0.7"),W.setAttribute("stroke","white"),W.setAttribute("stroke-width","0.002"),W.setAttribute("stroke-opacity","0.5"),W.style.cursor="pointer",W.style.transition="fill-opacity 0.2s",W.addEventListener("mouseenter",()=>{if(W.setAttribute("fill-opacity","1"),W.setAttribute("stroke-opacity","1"),P)P({index:U,x:Y,y:_,radius:Z})}),W.addEventListener("mouseleave",()=>{if(W.setAttribute("fill-opacity","0.7"),W.setAttribute("stroke-opacity","0.5"),P)P(null)}),Q.appendChild(W)}j.appendChild(Q),w.appendChild(j)}function R(w){w.innerHTML='<div class="placeholder-small">Loading circles...</div>'}function k(w,O){w.innerHTML=`<div class="placeholder-small" style="color: var(--error);">
    Error: ${O||"Failed to load circles"}
  </div>`}function B(w){if(!w)return"";return`Circle ${w.index}: center (${w.x.toFixed(4)}, ${w.y.toFixed(4)}), radius ${w.radius.toFixed(4)}`}var X={render:M,renderLoading:R,renderError:k,formatInfo:B};class F{state={experiments:[],currentExperiment:null,currentExperimentData:null,currentTrial:null,allTrials:[],allCircles:{},circlesLoading:!1,rootLogLoaded:!1,rootLog:[],logFilter:"all",logIndex:0,logViewAll:!0,modelFilter:"all"};elements;async init(){this.cacheElements(),this.bindEvents(),await this.loadExperiments()}cacheElements(){this.elements={experimentsList:document.getElementById("experiments-list"),noExperiment:document.getElementById("no-experiment"),experimentView:document.getElementById("experiment-view"),experimentName:document.getElementById("experiment-name"),experimentDate:document.getElementById("experiment-date"),experimentBestScore:document.getElementById("experiment-best-score"),experimentGenerations:document.getElementById("experiment-generations"),tabs:document.querySelectorAll(".tab"),tabPanels:document.querySelectorAll(".tab-panel"),generationsList:document.getElementById("generations-list"),circleCanvas:document.getElementById("circle-canvas"),circleInfo:document.getElementById("circle-info"),circlesLoading:document.getElementById("circles-loading"),trialPlaceholder:document.getElementById("trial-placeholder"),trialDetails:document.getElementById("trial-details"),trialTitle:document.getElementById("trial-title"),trialScore:document.getElementById("trial-score"),trialValid:document.getElementById("trial-valid"),trialParent:document.getElementById("trial-parent"),detailTabs:document.querySelectorAll(".detail-tab"),detailPanels:document.querySelectorAll(".detail-panel"),promptContent:document.getElementById("prompt-content"),responseContent:document.getElementById("response-content"),codeContent:document.getElementById("code-content"),lineageTree:document.getElementById("lineage-tree"),rootLogContainer:document.getElementById("root-log-container"),logFilters:document.querySelectorAll(".log-filter"),logPrev:document.getElementById("log-prev"),logNext:document.getElementById("log-next"),logPosition:document.getElementById("log-position"),logViewAll:document.getElementById("log-view-all"),modelSelect:document.getElementById("model-select")}}bindEvents(){this.elements.tabs.forEach((w)=>{w.addEventListener("click",()=>{let O=w.dataset.tab;if(O)this.switchTab(O)})}),this.elements.detailTabs.forEach((w)=>{w.addEventListener("click",()=>{let O=w.dataset.detail;if(O)this.switchDetailTab(O)})}),this.elements.logFilters.forEach((w)=>{w.addEventListener("click",()=>{let O=w.dataset.filter;if(O)this.setLogFilter(O)})}),this.elements.logPrev.addEventListener("click",()=>this.navigateLog(-1)),this.elements.logNext.addEventListener("click",()=>this.navigateLog(1)),this.elements.logViewAll.addEventListener("click",()=>this.toggleLogViewAll()),this.elements.modelSelect.addEventListener("change",()=>{this.state.modelFilter=this.elements.modelSelect.value,this.renderExperimentsList()})}async loadExperiments(){try{this.state.experiments=await J.getExperiments(),this.populateModelFilter(),this.renderExperimentsList()}catch(w){console.error("Failed to load experiments:",w),this.elements.experimentsList.innerHTML=`
        <div class="loading" style="color: var(--error);">
          Failed to load experiments
        </div>
      `}}populateModelFilter(){let w=new Set;for(let j of this.state.experiments)if(j.complete&&j.root_model)w.add(j.root_model);let O=Array.from(w).sort(),P='<option value="all">All Models</option>';for(let j of O){let q=this.shortenModelName(j);P+=`<option value="${j}">${q}</option>`}this.elements.modelSelect.innerHTML=P}shortenModelName(w){let O=w.split("/");return O.length>1?O[O.length-1]:w}renderExperimentsList(){let w=this.state.experiments.filter((P)=>P.complete);if(this.state.modelFilter!=="all")w=w.filter((P)=>P.root_model===this.state.modelFilter);let O=w.map((P)=>`
        <div class="experiment-item" data-id="${P.id}">
          <div class="name">${P.name}</div>
          <div class="meta">
            <span>${J.formatDate(P.timestamp)}</span>
            <span class="score">${P.best_score?J.formatScore(P.best_score):"-"}</span>
          </div>
        </div>
      `).join("");this.elements.experimentsList.innerHTML=O||'<div class="loading">No experiments found</div>',this.elements.experimentsList.querySelectorAll(".experiment-item").forEach((P)=>{P.addEventListener("click",()=>{let j=P.dataset.id;if(j)this.selectExperiment(j)})})}async selectExperiment(w){this.elements.experimentsList.querySelectorAll(".experiment-item").forEach((O)=>{O.classList.toggle("active",O.dataset.id===w)}),this.elements.noExperiment.classList.add("hidden"),this.elements.experimentView.classList.remove("hidden");try{this.state.currentExperiment=w,this.state.currentExperimentData=await J.getExperiment(w),this.state.rootLogLoaded=!1,this.state.allTrials=[],this.state.allCircles={},this.state.circlesLoading=!0,this.state.rootLog=[],this.state.logFilter="all",this.state.logIndex=0,this.state.logViewAll=!0,this.renderExperimentHeader(),await this.loadAllTrials(),this.renderGenerations(),this.switchTab("generations"),this.preloadCircles(w)}catch(O){console.error("Failed to load experiment:",O)}}renderExperimentHeader(){let w=this.state.currentExperimentData,O=this.state.experiments.find((j)=>j.id===this.state.currentExperiment);this.elements.experimentName.textContent=O?.name||this.state.currentExperiment||"",this.elements.experimentDate.textContent=J.formatDate(w.start_time);let P=w.best_trial?.sum_radii??w.best_trial?.score;this.elements.experimentBestScore.textContent=P?J.formatScore(P):"-",this.elements.experimentGenerations.textContent=`${w.num_generations} generations`}async loadAllTrials(){let w=this.state.currentExperimentData,O=[];for(let P=0;P<w.num_generations;P++)try{let j=await J.getGenerationTrials(this.state.currentExperiment,P);O.push(...j)}catch(j){console.error(`Failed to load gen ${P} trials:`,j)}this.state.allTrials=O}renderGenerations(){let P=(this.state.currentExperimentData.generations||[]).map((j,q)=>{let z=this.state.allTrials.filter((U)=>U.generation===q),K=j.best_trial_id,Q=j.best_sum_radii??j.best_score;return`
          <div class="generation-card" data-gen="${q}">
            <div class="generation-header">
              <h4>Gen ${q}</h4>
              <span class="best-score">${Q?J.formatScore(Q):"-"}</span>
            </div>
            <div class="trials-grid">
              ${z.map((U)=>{let Y=U.trial_id===K,_=U.metrics?.valid!==!1,Z=["trial-chip"];if(Y)Z.push("best");if(!_)Z.push("invalid");return`<span class="${Z.join(" ")}" data-trial="${U.trial_id}">${U.trial_id.split("_")[2]}</span>`}).join("")}
            </div>
          </div>
        `}).join("");this.elements.generationsList.innerHTML=P,this.elements.generationsList.querySelectorAll(".trial-chip").forEach((j)=>{j.addEventListener("click",()=>{let q=j.dataset.trial;if(q)this.selectTrial(q)})})}async selectTrial(w){this.elements.generationsList.querySelectorAll(".trial-chip").forEach((O)=>{O.classList.toggle("active",O.dataset.trial===w)}),this.elements.trialPlaceholder.classList.add("hidden"),this.elements.trialDetails.classList.remove("hidden");try{let O=await J.getTrial(this.state.currentExperiment,w);this.state.currentTrial=O,this.renderTrialDetails(O),this.renderCircles(w)}catch(O){console.error("Failed to load trial:",O)}}renderTrialDetails(w){this.elements.trialTitle.textContent=w.trial_id;let O=w.metrics?.sum_radii??w.metrics?.score??0;this.elements.trialScore.textContent=`Score: ${J.formatScore(O)}`;let P=w.metrics?.valid!==!1;if(this.elements.trialValid.textContent=P?"Valid":"Invalid",this.elements.trialValid.className=P?"valid":"invalid",w.parent_id&&w.parent_id!=="root"&&w.parent_id!=="null"){this.elements.trialParent.innerHTML=`Parent: <a data-trial="${w.parent_id}">${w.parent_id}</a>`;let j=this.elements.trialParent.querySelector("a");if(j)j.addEventListener("click",(q)=>{q.preventDefault(),this.selectTrial(w.parent_id)})}else this.elements.trialParent.innerHTML="Parent: root";this.elements.promptContent.innerHTML=marked.parse(w.prompt||"*No prompt*"),this.elements.responseContent.innerHTML=marked.parse(w.response||"*No response*"),this.elements.codeContent.textContent=w.code||"# No code",hljs.highlightElement(this.elements.codeContent)}async preloadCircles(w){this.elements.circlesLoading.classList.remove("hidden");try{console.log("Preloading circles...");let O=await J.getAllCircles(w);if(this.state.currentExperiment===w){if(this.state.allCircles=O,this.state.circlesLoading=!1,console.log(`Preloaded ${Object.keys(O).length} circle packings`),this.elements.circlesLoading.classList.add("hidden"),this.state.currentTrial)this.renderCircles(this.state.currentTrial.trial_id)}}catch(O){console.error("Failed to preload circles:",O),this.state.circlesLoading=!1,this.elements.circlesLoading.classList.add("hidden")}}renderCircles(w){let O=this.state.allCircles[w];if(O)if(O.valid)X.render(this.elements.circleCanvas,O,(P)=>{this.elements.circleInfo.textContent=P?X.formatInfo(P):`Sum of radii: ${J.formatScore(O.sum_radii)}`}),this.elements.circleInfo.textContent=`Sum of radii: ${J.formatScore(O.sum_radii)}`;else X.renderError(this.elements.circleCanvas,O.error);else if(this.state.circlesLoading)X.renderLoading(this.elements.circleCanvas),this.elements.circleInfo.textContent="Loading circles...";else this.loadTrialCircles(w)}async loadTrialCircles(w){X.renderLoading(this.elements.circleCanvas),this.elements.circleInfo.textContent="";try{let O=await J.getTrialCircles(this.state.currentExperiment,w);if(this.state.allCircles[w]=O,O.valid)X.render(this.elements.circleCanvas,O,(P)=>{this.elements.circleInfo.textContent=P?X.formatInfo(P):`Sum of radii: ${J.formatScore(O.sum_radii)}`}),this.elements.circleInfo.textContent=`Sum of radii: ${J.formatScore(O.sum_radii)}`;else X.renderError(this.elements.circleCanvas,O.error)}catch(O){console.error("Failed to load circles:",O),X.renderError(this.elements.circleCanvas,String(O))}}switchTab(w){if(this.elements.tabs.forEach((O)=>{O.classList.toggle("active",O.dataset.tab===w)}),this.elements.tabPanels.forEach((O)=>{O.classList.toggle("active",O.id===`tab-${w}`)}),w==="lineage"&&this.state.allTrials.length>0)this.renderLineageTree();else if(w==="root-log"&&!this.state.rootLogLoaded)this.loadRootLog()}switchDetailTab(w){this.elements.detailTabs.forEach((O)=>{O.classList.toggle("active",O.dataset.detail===w)}),this.elements.detailPanels.forEach((O)=>{O.classList.toggle("active",O.id===`detail-${w}`)})}renderLineageTree(){let w=this.state.currentExperimentData?.best_trial?.trial_id,O=J.buildLineageTree(this.state.allTrials),P=(q)=>{let z=q.metrics?.sum_radii??q.metrics?.score??0,K=q.metrics?.valid!==!1,Q=q.trial_id===w,U=["lineage-node-content"];if(!K)U.push("invalid");if(Q)U.push("best");let Y=`
        <div class="lineage-node">
          <div class="${U.join(" ")}" data-trial="${q.trial_id}">
            <div class="trial-id">${q.trial_id}${Q?" *":""}</div>
            <div class="node-score">${K?J.formatScore(z):"Invalid"}</div>
          </div>
        </div>
      `;if(q.children&&q.children.length>0){Y+='<div class="lineage-children">';for(let _ of q.children)Y+=P(_);Y+="</div>"}return Y},j=O.map((q)=>`
        <div class="lineage-root">
          ${P(q)}
        </div>
      `).join("");this.elements.lineageTree.innerHTML=j||'<div class="placeholder-small">No lineage data</div>',this.elements.lineageTree.querySelectorAll(".lineage-node-content").forEach((q)=>{q.addEventListener("click",()=>{this.switchTab("generations");let z=q.dataset.trial;if(z)this.selectTrial(z)})})}async loadRootLog(){this.elements.rootLogContainer.innerHTML='<div class="loading">Loading conversation...</div>';try{let w=await J.getRootLog(this.state.currentExperiment);this.state.rootLogLoaded=!0,this.state.rootLog=w||[],this.state.logIndex=0,this.state.logFilter="all",this.state.logViewAll=!0,this.elements.logFilters.forEach((O)=>{O.classList.toggle("active",O.dataset.filter==="all")}),this.elements.logViewAll.classList.add("active"),this.renderRootLog()}catch(w){console.error("Failed to load root log:",w),this.elements.rootLogContainer.innerHTML=`
        <div class="placeholder-small" style="color: var(--error);">
          Failed to load log: ${w}
        </div>
      `}}getFilteredLog(){if(this.state.logFilter==="all")return this.state.rootLog;return this.state.rootLog.filter((w)=>w.role===this.state.logFilter)}setLogFilter(w){this.state.logFilter=w,this.state.logIndex=0,this.elements.logFilters.forEach((O)=>{O.classList.toggle("active",O.dataset.filter===w)}),this.renderRootLog()}navigateLog(w){let O=this.getFilteredLog();if(O.length===0)return;if(this.state.logViewAll)this.state.logViewAll=!1,this.elements.logViewAll.classList.remove("active"),this.state.logIndex=w>0?0:O.length-1;else this.state.logIndex=Math.max(0,Math.min(O.length-1,this.state.logIndex+w));this.renderRootLog()}toggleLogViewAll(){this.state.logViewAll=!this.state.logViewAll,this.elements.logViewAll.classList.toggle("active",this.state.logViewAll),this.renderRootLog()}renderRootLog(){let w=this.getFilteredLog();if(w.length===0){this.elements.rootLogContainer.innerHTML='<div class="placeholder-small">No log entries found</div>',this.elements.logPosition.textContent="- / -";return}if(this.state.logViewAll)this.elements.logPosition.textContent=`All (${w.length})`;else this.elements.logPosition.textContent=`${this.state.logIndex+1} / ${w.length}`;let P=(this.state.logViewAll?w:[w[this.state.logIndex]]).map((j)=>{let q=j.role||"unknown",z=j.content||"",K=marked.parse(z),Q="";if(j.execution_result)Q=`
            <div class="log-execution-result">
              <h5>Execution Result</h5>
              <pre>${this.escapeHtml(j.execution_result)}</pre>
            </div>
          `;return`
          <div class="log-entry ${q}">
            <div class="log-entry-header">
              <span class="log-entry-role">${q}</span>
              <span class="log-entry-turn">Turn ${j.turn}</span>
            </div>
            <div class="log-entry-content">${K}</div>
            ${Q}
          </div>
        `}).join("");this.elements.rootLogContainer.innerHTML=P,this.elements.rootLogContainer.querySelectorAll("pre code").forEach((j)=>{hljs.highlightElement(j)})}escapeHtml(w){let O=document.createElement("div");return O.textContent=w,O.innerHTML}}var G=new F;document.addEventListener("DOMContentLoaded",()=>{G.init().catch(console.error)});
